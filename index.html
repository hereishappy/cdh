<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDH Productivity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray */
            color: #f3f4f6; /* Light Gray */
        }
        .card {
            background-color: #1f2937; /* Gray 800 */
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #9ca3af; /* Gray 400 */
        }
        .card-value {
            font-size: 2.25rem;
            font-weight: 800;
            color: #ffffff;
            transition: color 0.3s ease;
        }
        .performer-card {
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #4f46e5, #c026d3, #db2777);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }
        .star {
            position: absolute;
            color: #facc15; /* Yellow 400 */
            font-size: 1.5rem;
            animation: shine 2s infinite ease-in-out;
        }
        @keyframes shine {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        .star-1 { top: 10%; left: 10%; animation-delay: 0s; }
        .star-2 { top: 20%; right: 15%; animation-delay: 0.5s; }
        .star-3 { bottom: 15%; left: 25%; animation-delay: 1s; }
        .star-4 { bottom: 25%; right: 10%; animation-delay: 1.5s; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up { animation: slideUp 0.7s ease-out forwards; opacity: 0; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h2 {
            background-image: linear-gradient(to right, #a5b4fc, #f9a8d4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .modal-content .prose { color: #d1d5db; }
        .modal-content .prose h3 { color: #fff; border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem; margin-top: 1.5rem;}
        .modal-content .prose ul { list-style-type: '✓  '; padding-left: 1rem; }
        .modal-content .prose li { margin-bottom: 0.5rem; }
        .modal-content .prose strong { color: #a5b4fc; }

        /* AI Button Style */
        .ai-button {
            background-image: linear-gradient(to right, #4f46e5, #c026d3, #db2777);
            transition: all 0.3s ease;
        }
        .ai-button:hover {
            box-shadow: 0 0 20px rgba(192, 38, 211, 0.5);
            transform: translateY(-2px);
        }
        #ai-suggestions-hindi p {
            font-size: 1.125rem; /* Equivalent to text-lg */
            line-height: 1.75rem; /* Equivalent to leading-relaxed */
            margin-bottom: 0.75rem; /* Equivalent to mb-3 */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-500">CDH Productivity Dashboard</span>
            </h1>
            <p class="mt-2 text-lg text-gray-400">Live Data Updates Every 5 Minutes</p>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-8">
            <div id="target-card" class="card slide-up" style="animation-delay: 0.1s;"></div>
            <div id="avg-workload-card" class="card slide-up" style="animation-delay: 0.2s;"></div>
            <div id="erection-card" class="card slide-up" style="animation-delay: 0.3s;"></div>
            <div id="dismantling-card" class="card slide-up" style="animation-delay: 0.4s;"></div>
            <div id="manhours-card" class="card slide-up" style="animation-delay: 0.5s;"></div>
            <div id="avg-productivity-card" class="card slide-up" style="animation-delay: 0.6s;"></div>
        </div>
        
        <div class="text-center mb-8">
            <button id="gemini-insights-btn" class="ai-button text-white font-bold py-3 px-6 rounded-full shadow-lg text-lg">
                ✨ Get Detailed AI Insights (English)
            </button>
        </div>

        <div class="mb-8">
            <h2 class="text-3xl font-bold text-white mb-4 text-center">Top Performers</h2>
            <div id="top-performers-container" class="relative h-48">
                </div>
        </div>

        <div class="card p-4 md:p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">AI Insights Suggestions (AI सुझाव)</h2>
            <div id="ai-suggestions-hindi" class="text-gray-300 text-lg leading-relaxed min-h-[100px] flex items-center justify-center text-center">
                <p>सुझावों के लिए डेटा का विश्लेषण किया जा रहा है...</p>
            </div>
        </div>
        
        <div id="loading-indicator" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="text-center">
                <svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-white text-lg">Fetching Live Data...</p>
            </div>
        </div>
        
        <div id="ai-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">✨ AI Performance Analysis (English)</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div>
                <div id="ai-insights-content" class="prose">
                    </div>
            </div>
        </div>

    </div>

    <script>
        const PRODUCTIVITY_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR770AQ-HHixlcLynNRlnX01iKGuoWbQjYKL4HuVkL6dkiQlneLSmavh0ol0qfNln4UTN20ZXIQ8yuY/pub?gid=67021281&single=true&output=csv';
        const ALL_OVER_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR770AQ-HHixlcLynNRlnX01iKGuoWbQjYKL4HuVkL6dkiQlneLSmavh0ol0qfNln4UTN20ZXIQ8yuY/pub?gid=834519060&single=true&output=csv';

        const loadingIndicator = document.getElementById('loading-indicator');
        const aiModal = document.getElementById('ai-modal');
        const aiInsightsBtn = document.getElementById('gemini-insights-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const aiInsightsContent = document.getElementById('ai-insights-content');
        const aiSuggestionsHindi = document.getElementById('ai-suggestions-hindi');
        
        let performerInterval = null;
        let lastProductivityData = null;
        let lastAllOverData = null;

        // Function to fetch and parse CSV data
        function fetchData(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }
        
        function updateCard(elementId, title, value, unit = '') {
            const card = document.getElementById(elementId);
            if (!card) return;
            const formattedValue = isNaN(parseFloat(value)) ? value : parseFloat(value).toLocaleString('en-IN', { maximumFractionDigits: 2 });
            card.innerHTML = `<div class="card-title">${title}</div><div class="card-value fade-in">${formattedValue} ${unit}</div>`;
        }

        function updateTopPerformers(data) {
            const container = document.getElementById('top-performers-container');
            if (!container) return;
            const performers = data.map(row => ({ name: row['SUP NAME'], productivity: parseFloat(row['PRODUCTIVITY']) })).filter(p => p.name && !isNaN(p.productivity) && p.productivity > 0).sort((a, b) => b.productivity - a.productivity).slice(0, 5);
            container.innerHTML = '';
            if (performers.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400">No performance data available.</p>`;
                return;
            }
            performers.forEach((performer, index) => {
                const card = document.createElement('div');
                card.className = 'performer-card card absolute w-full transition-opacity duration-1000 ease-in-out';
                card.style.opacity = index === 0 ? '1' : '0';
                card.style.zIndex = performers.length - index;
                card.innerHTML = `<div class="star star-1">✨</div><div class="star star-2">🌟</div><div class="star star-3">⭐</div><div class="star star-4">💫</div><div class="text-center"><div class="text-2xl font-bold text-white">${performer.name}</div><div class="text-lg text-gray-300">Productivity: <span class="font-bold text-xl text-yellow-300">${performer.productivity.toFixed(2)}</span></div></div>`;
                container.appendChild(card);
            });
            if (performerInterval) clearInterval(performerInterval);
            if (performers.length > 1) {
                let currentIndex = 0;
                performerInterval = setInterval(() => {
                    const cards = container.children;
                    cards[currentIndex].style.opacity = '0';
                    currentIndex = (currentIndex + 1) % performers.length;
                    cards[currentIndex].style.opacity = '1';
                }, 5000);
            }
        }
        
        async function callGeminiAPI(prompt) {
            // IMPORTANT: Replace "YOUR_API_KEY_HERE" with your actual Gemini API key.
            // For production environments, consider more secure ways to handle API keys.
            const apiKey = ""; // Your Gemini API Key here
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("Invalid response structure from API or no content generated.");
            }
        }

        async function getGeminiInsights() {
            if (!lastProductivityData || !lastAllOverData) {
                alert("Data not loaded yet. Please wait a moment.");
                return;
            }
            
            aiInsightsContent.innerHTML = `<div class="flex justify-center items-center"><svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="ml-4 text-lg">Analyzing data...</p></div>`;
            aiModal.classList.add('visible');

            const performers = lastProductivityData.map(row => ({ name: row['SUP NAME'], productivity: parseFloat(row['PRODUCTIVITY']) })).filter(p => p.name && !isNaN(p.productivity));
            const topPerformers = performers.filter(p => p.productivity > 0).sort((a, b) => b.productivity - a.productivity).slice(0, 3);
            const lowPerformers = performers.filter(p => p.productivity === 0);
            const recentData = lastAllOverData.slice(-7);
            const totalManhours = lastProductivityData.reduce((sum, row) => sum + (parseFloat(row['TOTAL MANHOURS']) || 0), 0);
            const overallTarget = totalManhours * 3.3; // Corrected calculation for target

            const prompt = `
                You are a construction project productivity analyst for a company named CDH. It is currently ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })} (IST). Analyze the following performance data and provide a concise report in Markdown format.

                **Key Metrics:**
                - Overall Target: ${overallTarget.toFixed(2)}
                
                **Top Performers (Name: Productivity Score):**
                ${topPerformers.map(p => `- ${p.name}: ${p.productivity.toFixed(2)}`).join('\n')}

                **Supervisors with Zero Productivity:**
                ${lowPerformers.map(p => `- ${p.name}`).join('\n')}

                **Recent Daily Performance (last 7 days - Date: Achieved vs Target):**
                ${recentData.map(d => `- ${d.DATE}: ${parseFloat(d.ACHEIVED) || 0} vs ${(parseFloat(d['TOTAL MANHOURS']) || 0) * 3.3}`).join('\n')}

                Based on this data, provide:
                ### Overall Summary
                A brief, encouraging overview of the team's performance, mentioning the overall target.

                ### Key Observations
                Point out 2-3 significant trends or findings.

                ### Actionable Recommendations
                Suggest 2-3 specific, practical steps to improve overall productivity. Address the zero-productivity supervisors.

                ### Spotlight on Success
                Briefly praise the top performer(s) by name.
            `;

            try {
                const text = await callGeminiAPI(prompt);
                aiInsightsContent.innerHTML = marked.parse(text);
            } catch (error) {
                console.error("Gemini API Error for detailed insights:", error);
                aiInsightsContent.innerHTML = `<p class="text-red-400">Sorry, I couldn't retrieve AI insights at the moment. Please try again later.</p>`;
            }
        }

        async function getHindiSuggestions() {
            if (!lastProductivityData || !lastAllOverData) {
                aiSuggestionsHindi.innerHTML = `<p class="text-gray-400">सुझावों के लिए डेटा उपलब्ध नहीं है।</p>`;
                return;
            }
            
            aiSuggestionsHindi.innerHTML = `<div class="flex justify-center items-center"><svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="ml-2">सुझावों का विश्लेषण जारी है...</p></div>`;

            const performers = lastProductivityData.map(row => ({ name: row['SUP NAME'], productivity: parseFloat(row['PRODUCTIVITY']) })).filter(p => p.name && !isNaN(p.productivity));
            const topPerformer = performers.filter(p => p.productivity > 0).sort((a, b) => b.productivity - a.productivity)[0];
            const lowPerformersCount = performers.filter(p => p.productivity === 0).length;
            const currentTotalManhours = lastProductivityData.reduce((sum, row) => sum + (parseFloat(row['TOTAL MANHOURS']) || 0), 0);
            const currentAvgProductivity = performers.filter(p => !isNaN(p.productivity) && isFinite(p.productivity)).reduce((sum, p) => sum + p.productivity, 0) / performers.length;
            const overallTarget = currentTotalManhours * 3.3;


            const promptHindi = `
                आप CDH कंपनी के लिए एक निर्माण परियोजना उत्पादकता विश्लेषक हैं। वर्तमान समय ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })} (IST) है। आपको दिए गए डेटा के आधार पर हिंदी में 2-3 संक्षिप्त, सकारात्मक और कार्रवाई योग्य सुझाव देने हैं। यदि कोई सुपरवाइजर शून्य उत्पादकता पर है, तो उस पर विशेष ध्यान दें।

                **मुख्य मेट्रिक्स:**
                - कुल मैन-घंटे: ${currentTotalManhours.toFixed(2)}
                - औसत उत्पादकता: ${currentAvgProductivity.toFixed(2)}
                - कुल लक्ष्य: ${overallTarget.toFixed(2)}
                ${topPerformer ? `- शीर्ष प्रदर्शनकर्ता: ${topPerformer.name} (${topPerformer.productivity.toFixed(2)} उत्पादकता)` : ''}
                ${lowPerformersCount > 0 ? `- शून्य उत्पादकता वाले सुपरवाइजर: ${lowPerformersCount} ` : ''}

                इन डेटा के आधार पर, टीम की उत्पादकता में सुधार के लिए 2-3 महत्वपूर्ण सुझाव हिंदी में दें। सुनिश्चित करें कि सुझाव सकारात्मक और लागू करने योग्य हों। यदि शून्य उत्पादकता वाले सुपरवाइजर हैं, तो उनके लिए विशिष्ट मार्गदर्शन शामिल करें।
                आउटपुट केवल सुझावों के साथ बुलेट पॉइंट लिस्ट के रूप में होना चाहिए।
            `;

            try {
                const text = await callGeminiAPI(promptHindi);
                aiSuggestionsHindi.innerHTML = marked.parse(text); // Use marked.parse for markdown output
            } catch (error) {
                console.error("Gemini API Error for Hindi suggestions:", error);
                aiSuggestionsHindi.innerHTML = `<p class="text-red-400">सुझावों को प्राप्त करने में त्रुटि हुई। कृपया बाद में पुनः प्रयास करें।</p>`;
            }
        }

        async function updateDashboard() {
            loadingIndicator.style.display = 'flex';
            try {
                const [productivityData, allOverData] = await Promise.all([
                    fetchData(PRODUCTIVITY_URL),
                    fetchData(ALL_OVER_URL)
                ]);

                lastProductivityData = productivityData;
                lastAllOverData = allOverData;

                const sumErection = productivityData.reduce((sum, row) => sum + (parseFloat(row.ERECTION) || 0), 0);
                const sumDismantling = productivityData.reduce((sum, row) => sum + (parseFloat(row.DISMANTLING) || 0), 0);
                const totalManhours = productivityData.reduce((sum, row) => sum + (parseFloat(row['TOTAL MANHOURS']) || 0), 0);
                const validProductivity = productivityData.map(row => parseFloat(row.PRODUCTIVITY)).filter(p => !isNaN(p) && isFinite(p));
                const avgProductivity = validProductivity.length > 0 ? validProductivity.reduce((sum, p) => sum + p, 0) / validProductivity.length : 0;
                
                // --- UPDATED CALCULATIONS ---
                const target = totalManhours * 3.3; 
                const avgWorkload = (sumDismantling / 2) + sumErection;
                // --- END UPDATED CALCULATIONS ---


                updateCard('target-card', 'Overall Target', target);
                updateCard('avg-workload-card', 'Avg. Workload', avgWorkload);
                updateCard('erection-card', 'Sum of Erection', sumErection);
                updateCard('dismantling-card', 'Sum of Dismantling', sumDismantling);
                updateCard('manhours-card', 'Total Manhours', totalManhours);
                updateCard('avg-productivity-card', 'Average Productivity', avgProductivity.toFixed(2));
                
                updateTopPerformers(productivityData);
                getHindiSuggestions(); // Call to load Hindi suggestions

            } catch (error) {
                console.error('Failed to update dashboard:', error);
                document.body.innerHTML = `<div class="text-center text-red-500 p-8">Error loading dashboard data. Please check the console for details.</div>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // Event Listeners
        aiInsightsBtn.addEventListener('click', getGeminiInsights);
        closeModalBtn.addEventListener('click', () => aiModal.classList.remove('visible'));
        aiModal.addEventListener('click', (e) => {
            if (e.target === aiModal) {
                aiModal.classList.remove('visible');
            }
        });

        // Initial load and set interval for updates
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            setInterval(updateDashboard, 300000); // 5 minutes (300000 milliseconds)
        });
    </script>
</body>
</html>
